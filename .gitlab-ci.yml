stages:
  - inject_backend
  - terraform

variables:
  TF_VAR_location: "eastus"

inject_backend:
  stage: inject_backend
  image: python:3.11
  script:
    - python3 scripts/inject_backend.py "$PROJECT_NAME" "$SUBGROUP"
  artifacts:
    paths:
      - "$PROJECT_NAME/environment/*/backend.hcl"
    expire_in: 1 hour

terraform_apply:
  stage: terraform
  image: hashicorp/terraform:1.7.0
  needs: ["inject_backend"]
  parallel:
    matrix:
      - ENVIRONMENT: ["QA", "UAT", "PROD"]

  script:
    - ENV_BACKEND="$PROJECT_NAME/environment/${ENVIRONMENT}/backend.hcl"
    - echo "ðŸ”§ Using backend: $ENV_BACKEND"
    - terraform init -backend-config="$ENV_BACKEND"
    - terraform plan -out=tfplan \
        -var "project_name=$PROJECT_NAME" \
        -var "subgroup=$SUBGROUP" \
        -var "environment=${ENVIRONMENT}" \
        -var "arm_client_id=${ARM_CLIENT_ID_${ENVIRONMENT}}" \
        -var "arm_client_secret=${ARM_CLIENT_SECRET_${ENVIRONMENT}}" \
        -var "arm_tenant_id=${ARM_TENANT_ID_${ENVIRONMENT}}" \
        -var "arm_subscription_id=${ARM_SUBSCRIPTION_ID_${ENVIRONMENT}}"
    - terraform apply -auto-approve tfplan

  variables:
    ARM_CLIENT_ID: "$ARM_CLIENT_ID_${ENVIRONMENT}"
    ARM_CLIENT_SECRET: "$ARM_CLIENT_SECRET_${ENVIRONMENT}"
    ARM_TENANT_ID: "$ARM_TENANT_ID_${ENVIRONMENT}"
    ARM_SUBSCRIPTION_ID: "$ARM_SUBSCRIPTION_ID_${ENVIRONMENT}"
